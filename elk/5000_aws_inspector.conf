# Author: Alberto Marziali
# Email: alberto.marziali.am@gmail.com  
# Last Update: 07/04/2021
# Version 0.3
# Description: Take in awsinspector reports from vulnWhisperer and pumps into logstash


input {
  file {
    path => "/opt/scanaggregator/scan/awsinspector/*.csv"
    mode => "read"
    start_position => "beginning"
    file_completed_action => "delete"
    sincedb_path => "/dev/null"
    tags => "awsinspector"
  }
}

filter {
  if "awsinspector" in [tags] {
    # Drop the header column
    if [message] =~ "^Agent ID" { drop {} }

    csv {
      columns => ["agent_id", "cve", "cvss2_score", "cvss2_severity", "cvss3_score", "description", "last_seen", "package_name", "public_ip", "recommendation", "scan_arn", "scan_name", "tag", "title"]
      separator => ","
      source => "message"
    }

    date {
      match => [ "last_seen", "UNIX" ]
      target => "last_seen"
    }

     ruby {
      code => "if event.get('description')
                  event.set('description', event.get('description').gsub(92.chr + 'n', 10.chr).gsub(92.chr + 'r', 13.chr))
              end
                if event.get('recommendation')
                  event.set('recommendation', event.get('recommendation').gsub(92.chr + 'n', 10.chr).gsub(92.chr + 'r', 13.chr))
              end
                if event.get('title')
                  event.set('title', event.get('title').gsub(92.chr + 'n', 10.chr).gsub(92.chr + 'r', 13.chr))
              end"
    }

    if ![agent_id] or [agent_id] == "nan" {
      mutate { remove_field => [ "agent_id" ] }
    }
    if ![cve] or [cve] == "nan" {
      mutate { remove_field => [ "cve" ] }
    }
    if ![cvss2_score] or [cvss2_score] == "nan" {
      mutate { remove_field => [ "cvss2_score" ] }
    }
    if ![cvss2_severity] or [cvss2_severity] == "nan" {
      mutate { remove_field => [ "cvss2_severity" ] }
    }
    if ![cvss3_score] or [cvss3_score] == "nan" {
      mutate { remove_field => [ "cvss3_score" ] }
    }
    if ![description] or [description] == "nan" {
      mutate { remove_field => [ "description" ] }
    }
    if ![last_seen] or [last_seen] == "nan" {
      mutate { remove_field => [ "last_seen" ] }
    }
    if ![package_name] or [package_name] == "nan" {
      mutate { remove_field => [ "package_name" ] }
    }
    if ![public_ip] or [public_ip] == "nan" {
      mutate { remove_field => [ "public_ip" ] }
    }
    if ![recommendation] or [recommendation] == "nan" {
      mutate { remove_field => [ "recommendation" ] }
    }
    if ![scan_arn] or [scan_arn] == "nan" {
      mutate { remove_field => [ "scan_arn" ] }
    }
    if ![scan_name] or [scan_name] == "nan" {
      mutate { remove_field => [ "scan_name" ] }
    }
    if ![tag] or [tag] == "nan" {
      mutate { remove_field => [ "tag" ] }
    }
    if ![title] or [title] == "nan" {
      mutate { remove_field => [ "title" ] }
    }

    mutate {
      remove_field => [ "message" ]
    }

    mutate {convert => ["cvss2_score", "float"]}
    mutate {convert => ["cvss3_score", "float"]}

  }
}

output {
  if "awsinspector" in [tags]{
    stdout {
      codec => dots
    }
    elasticsearch {
      hosts => [ "https://localhost:9200" ]
      index => "logstash-awsinspector-%{+YYYY.MM.dd}"
    }
  }
}
