input { 
	file {
		path => "/opt/scanaggregator/scan/nikto/*.csv"
		mode => "read"
		start_position => "beginning"
		file_completed_action => "delete"
		sincedb_path => "/dev/null"
		tags => "niktowrapper"
	}
}
filter {
	if "niktowrapper" in [tags] {
		if [message] =~ "^hostname" { drop {} }
		csv {
			separator => ","
			columns => [ "hostname", "ip", "port", "osvdb", "httpmethod", "uri", "result", "branch"]
			source => "message"
		}
	
		if ![hostname] or [hostname] == "nan" {
		mutate { remove_field => [ "hostname" ] }
		}
		if ![osvdb] or [osvdb] == "nan" {
		mutate { remove_field => [ "osvdb" ] }
		}
		if ![httpmethod] or [httpmethod] == "nan" {
		mutate { remove_field => [ "httpmethod" ] }
		}
		if ![uri] or [uri] == "nan" {
		mutate { remove_field => [ "uri" ] }
		}
		if ![branch] or [branch] == "nan" {
		mutate { remove_field => [ "branch" ] }
		}

		mutate {
			remove_field => [ "message" ]
		}

		mutate {convert => ["port", "integer"]}

		# geographic location
		geoip {
			source => "ip"
		}

		fingerprint {
			source => ["ip", "port", "result"]
			concatenate_sources => true
		}
	}
}

output { 
	if "niktowrapper" in [tags] {
		elasticsearch {
			hosts => ["https://localhost:9200"]
			user => admin
			password => admin
			manage_template => false
			ssl_certificate_verification => false
			index => "logstash-niktowrapper"
			action => "update"
			doc_as_upsert => true
			document_id => "%{fingerprint}"
		}
		stdout { codec => dots }
	}
}
